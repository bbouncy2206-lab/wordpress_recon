name: WordPress ULTIMATE Recon & Security Scan
on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'ðŸŽ¯ URL du site WordPress Ã  scanner'
        required: true
        type: string
        placeholder: 'https://example.com'
      intensity:
        description: 'ðŸ’¥ Niveau d intensitÃ©'
        required: true
        default: 'aggressive'
        type: choice
        options:
        - stealth
        - aggressive  
        - nuclear
      scan_type:
        description: 'ðŸ”§ Type de scan'
        required: true
        default: 'full'
        type: choice
        options:
        - quick
        - full
        - comprehensive
  schedule:
    - cron: '0 3 * * *'  # Tous les jours Ã  3h
  push:
    branches: [ main ]

jobs:
  wordpress-ultimate-recon:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate target URL
      run: |
        echo "ðŸŽ¯ Target URL: ${{ github.event.inputs.target_url }}"
        if [[ ! ${{ github.event.inputs.target_url }} =~ ^https?:// ]]; then
          echo "âŒ ERROR: URL must start with http:// or https://"
          exit 1
        fi
        echo "âœ… URL validation passed"
        
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential \
          libcurl4-openssl-dev git python3 python3-pip python3-venv \
          golang-go npm nodejs unzip wget curl jq nmap whois \
          dnsutils nikto libxml2-dev libxslt-dev
        
    # === SECTION NUCLEI - INSTALLATION MANUELLE ===
    - name: Install Nuclei manually
      run: |
        echo "ðŸ”§ Installing Nuclei manually..."
        # TÃ©lÃ©chargement et installation de Nuclei
        go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
        
    - name: Update Nuclei templates
      run: |
        echo "ðŸ“¦ Updating Nuclei templates..."
        export PATH=$PATH:$(go env GOPATH)/bin
        nuclei -update-templates
        
    # === SECTION WPScan - INSTALLATION CORRIGÃ‰E ===  
    - name: Install WPScan with proper permissions
      run: |
        echo "ðŸ›¡ï¸ Installing WPScan with user permissions..."
        # Installation en mode user pour Ã©viter les problÃ¨mes de permissions
        gem install --user-install wpscan
        export PATH="$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH"
        wpscan --update
        
    # === SECTION CMSMAP ===
    - name: Install CMSmap
      run: |
        git clone https://github.com/Dionach/CMSmap.git
        cd CMSmap && pip3 install . --user
        
    # === SECTION WPSeku ===
    - name: Install WPSeku
      run: |
        git clone https://github.com/m4ll0k/WPSeku.git wpseku
        cd wpseku && pip3 install -r requirements.txt --user
        
    # === SECTION WPSCAN PLUS ===
    - name: Install wpscan-plus
      run: |
        git clone https://github.com/0x4544474154/wpscan-plus.git
        
    # === SECTION WORDPRESS-SCAN ===
    - name: Install wordpress-scan
      run: |
        git clone https://github.com/wpscanteam/wordpress-scan.git
        cd wordpress-scan
        gem install --user-install bundler
        export PATH="$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH"
        bundle install --path vendor/bundle
        
    # === SECTION WPFINGER ===
    - name: Install wpfinger
      run: |
        git clone https://github.com/mazen160/wpfinger.git
        cd wpfinger && pip3 install -r requirements.txt --user
        
    # === SECTION WPCONTEXT ===
    - name: Install wpcontext
      run: |
        pip3 install wpcontext --user
        
    # === SECTION WPLOOKUP ===
    - name: Install wplookup
      run: |
        npm install -g wplookup
        
    # === SECTION WORDPRESS-PENTESTING-FRAMEWORK ===
    - name: Install WPF
      run: |
        git clone https://github.com/rastating/wordpress-pentesting-framework.git
        cd wordpress-pentesting-framework
        gem install --user-install bundler
        export PATH="$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH"
        bundle install --path vendor/bundle
        
    # === SECTION WPSQLI ===
    - name: Install wpsqli
      run: |
        git clone https://github.com/0x4544474154/wpsqli.git
        
    # === SECTION WPXF ===
    - name: Install wpxf
      run: |
        git clone https://github.com/rastating/wpxf.git
        cd wpxf
        gem install --user-install bundler
        export PATH="$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH"
        bundle install --path vendor/bundle
        
    # === SECTION SUBDOMAIN RECON ===
    - name: Install subdomain tools
      run: |
        # Subfinder
        go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        
        # Assetfinder
        go install github.com/tomnomnom/assetfinder@latest
        
    # === CONFIGURATION DU PATH ===
    - name: Setup environment paths
      run: |
        echo "ðŸ”§ Setting up environment paths..."
        echo "PATH=$HOME/.local/bin:$(go env GOPATH)/bin:$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH" >> $GITHUB_ENV
        echo "GEM_HOME=$HOME/.local/share/gem/ruby/3.2.0" >> $GITHUB_ENV
        echo "GEM_PATH=$HOME/.local/share/gem/ruby/3.2.0" >> $GITHUB_ENV
        
    # === VERIFICATION DES OUTILS ===
    - name: Verify tools installation
      run: |
        echo "ðŸ” Verifying installed tools..."
        nuclei -version && echo "âœ… Nuclei installed"
        wpscan --version && echo "âœ… WPScan installed"
        python3 --version && echo "âœ… Python installed"
        go version && echo "âœ… Go installed"
        
    # === LANCEMENT DES SCANS ===
    
    - name: Run Ultimate Nuclei Scan
      run: |
        echo "ðŸŽ¯ Starting ULTIMATE Nuclei Scan on: ${{ github.event.inputs.target_url }}"
        nuclei -u "${{ github.event.inputs.target_url }}" \
        -t http/technologies/wordpress/ \
        -t http/vulnerabilities/wordpress/ \
        -t http/misconfiguration/wordpress/ \
        -t http/exposed-panels/wordpress/ \
        -t http/technologies/wordpress-themes/ \
        -t http/technologies/wordpress-plugins/ \
        -t http/files/wordpress/ \
        -t http/vulnerabilities/wordpress-plugins/ \
        -t http/vulnerabilities/wordpress-themes/ \
        -t http/vulnerabilities/wordpress/login-bypass.yaml \
        -t http/exposures/configs/ \
        -t http/exposures/backups/ \
        -t http/exposures/logs/ \
        -t http/exposed-panels/ \
        -severity low,medium,high,critical \
        -rate-limit 100 \
        -concurrency 30 \
        -timeout 10 \
        -retries 3 \
        -headless \
        -system-resolvers \
        -silent \
        -o nuclei-ultimate-results.txt
      continue-on-error: true
    
    - name: Run Nuclear WPScan
      run: |
        echo "ðŸ”¥ Starting NUCLEAR WPScan on: ${{ github.event.inputs.target_url }}"
        wpscan --url "${{ github.event.inputs.target_url }}" \
        --enumerate vp,vt,tt,cb,dbe,u,m \
        --plugins-detection mixed \
        --plugins-version-detection mixed \
        --themes-detection mixed \
        --themes-version-detection mixed \
        --max-threads 10 \
        -t 5 \
        --request-timeout 30 \
        --detection-mode mixed \
        --random-user-agent \
        --ignore-main-redirect \
        --disable-tls-checks \
        --format cli-no-colour \
        --output wpscan-nuclear-results.txt
      env:
        WPSCAN_API_TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}
      continue-on-error: true
    
    - name: Run CMSmap Scan
      run: |
        echo "ðŸ—ºï¸ Starting CMSmap on: ${{ github.event.inputs.target_url }}"
        cd CMSmap && python3 cmsmap.py -t "${{ github.event.inputs.target_url }}" -f W --no-output --quiet
        cp output/*.txt ../cmsmap-results.txt 2>/dev/null || echo "No CMSmap output"
        
    - name: Run WPSeku Scan
      run: |
        echo "âš¡ Starting WPSeku on: ${{ github.event.inputs.target_url }}"
        cd wpseku && python3 wpseku.py -u "${{ github.event.inputs.target_url }}" --verbose > ../wpseku-results.txt 2>&1 || true
        
    - name: Run wpscan-plus
      run: |
        echo "âž• Starting wpscan-plus on: ${{ github.event.inputs.target_url }}"
        cd wpscan-plus && ruby wpscan-plus.rb -u "${{ github.event.inputs.target_url }}" > ../wpscan-plus-results.txt 2>&1 || true
        
    - name: Run wordpress-scan
      run: |
        echo "ðŸ” Starting wordpress-scan on: ${{ github.event.inputs.target_url }}"
        cd wordpress-scan && bundle exec ruby wordpress-scan.rb --url "${{ github.event.inputs.target_url }}" --no-color > ../wordpress-scan-results.txt 2>&1 || true
        
    - name: Run wpfinger
      run: |
        echo "ðŸ‘† Starting wpfinger on: ${{ github.event.inputs.target_url }}"
        cd wpfinger && python3 wpfinger.py -t "${{ github.event.inputs.target_url }}" > ../wpfinger-results.txt 2>&1 || true
        
    - name: Run wpcontext
      run: |
        echo "ðŸŽ­ Starting wpcontext on: ${{ github.event.inputs.target_url }}"
        wpcontext --url "${{ github.event.inputs.target_url }}" --output wpcontext-results.txt || true
        
    - name: Run wplookup
      run: |
        echo "ðŸ‘€ Starting wplookup on: ${{ github.event.inputs.target_url }}"
        wplookup "${{ github.event.inputs.target_url }}" > wplookup-results.txt 2>&1 || true
        
    - name: Run wpsqli scan
      run: |
        echo "ðŸ’‰ Testing wpsqli on: ${{ github.event.inputs.target_url }}"
        cd wpsqli && python3 wpsqli.py -u "${{ github.event.inputs.target_url }}" --check > ../wpsqli-results.txt 2>&1 || true
        
    - name: Run Subdomain Discovery
      run: |
        echo "ðŸŒ Starting Subdomain Discovery for: ${{ github.event.inputs.target_url }}"
        domain=$(echo "${{ github.event.inputs.target_url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        echo "Domain extracted: $domain"
        
        # Subfinder
        subfinder -d $domain -silent > subfinder-results.txt 2>&1 || true
        
        # Assetfinder  
        assetfinder $domain > assetfinder-results.txt 2>&1 || true
        
    - name: Run Nikto Scan
      run: |
        echo "ðŸš¨ Starting Nikto on: ${{ github.event.inputs.target_url }}"
        domain=$(echo "${{ github.event.inputs.target_url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        nikto -h $domain -o nikto-results.txt || true
        
    - name: Run Nmap WordPress Scripts
      run: |
        echo "ðŸ“¡ Starting Nmap WordPress scripts on: ${{ github.event.inputs.target_url }}"
        domain=$(echo "${{ github.event.inputs.target_url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        nmap -p 80,443 --script http-wordpress-enum,http-wordpress-brute,http-wordpress-users $domain > nmap-wp-results.txt 2>&1 || true
        
    - name: Generate ULTIMATE Report
      run: |
        echo "# ðŸš€ RAPPORT ULTIME DE RECON WORDPRESS" > ULTIMATE-REPORT.md
        echo "## Scan rÃ©alisÃ© le $(date)" >> ULTIMATE-REPORT.md
        echo "### ðŸŽ¯ Cible: ${{ github.event.inputs.target_url }}" >> ULTIMATE-REPORT.md
        echo "### ðŸ’¥ IntensitÃ©: ${{ github.event.inputs.intensity }}" >> ULTIMATE-REPORT.md
        echo "### ðŸ”§ Type: ${{ github.event.inputs.scan_type }}" >> ULTIMATE-REPORT.md
        echo "" >> ULTIMATE-REPORT.md
        
        echo "## ðŸ“Š OUTILS UTILISÃ‰S" >> ULTIMATE-REPORT.md
        echo "- ðŸ” **Nuclei** - Scanning de vulnÃ©rabilitÃ©s" >> ULTIMATE-REPORT.md
        echo "- ðŸ›¡ï¸ **WPScan** - Scanner WordPress principal" >> ULTIMATE-REPORT.md
        echo "- ðŸ—ºï¸ **CMSmap** - Mapping CMS" >> ULTIMATE-REPORT.md
        echo "- âš¡ **WPSeku** - SÃ©curitÃ© WordPress" >> ULTIMATE-REPORT.md
        echo "- âž• **wpscan-plus** - WPScan amÃ©liorÃ©" >> ULTIMATE-REPORT.md
        echo "- ðŸ” **wordpress-scan** - Scanner alternatif" >> ULTIMATE-REPORT.md
        echo "- ðŸ‘† **wpfinger** - Fingerprinting WordPress" >> ULTIMATE-REPORT.md
        echo "- ðŸŽ­ **wpcontext** - Analyse de contexte" >> ULTIMATE-REPORT.md
        echo "- ðŸ‘€ **wplookup** - Recherche d'infos" >> ULTIMATE-REPORT.md
        echo "- ðŸ’‰ **wpsqli** - Tests SQLi" >> ULTIMATE-REPORT.md
        echo "- ðŸŒ **Subdomain Tools** - Discovery" >> ULTIMATE-REPORT.md
        echo "- ðŸš¨ **Nikto** - Scanner web" >> ULTIMATE-REPORT.md
        echo "- ðŸ“¡ **Nmap** - Scanning rÃ©seau" >> ULTIMATE-REPORT.md
        echo "" >> ULTIMATE-REPORT.md
        
        echo "## ðŸ“ˆ RÃ‰SULTATS PAR OUTIL" >> ULTIMATE-REPORT.md
        
        # Nuclei Results
        echo "### ðŸ” NUCLEI RESULTS" >> ULTIMATE-REPORT.md
        if [ -s nuclei-ultimate-results.txt ]; then
          cat nuclei-ultimate-results.txt >> ULTIMATE-REPORT.md
        else
          echo "Aucun rÃ©sultat Nuclei" >> ULTIMATE-REPORT.md
        fi
        echo "" >> ULTIMATE-REPORT.md
        
        # WPScan Results
        echo "### ðŸ›¡ï¸ WPSCAN RESULTS" >> ULTIMATE-REPORT.md
        if [ -s wpscan-nuclear-results.txt ]; then
          tail -50 wpscan-nuclear-results.txt >> ULTIMATE-REPORT.md
        else
          echo "Aucun rÃ©sultat WPScan" >> ULTIMATE-REPORT.md
        fi
        echo "" >> ULTIMATE-REPORT.md
        
        echo "## ðŸŽ¯ RÃ‰SUMÃ‰ DES VULNÃ‰RABILITÃ‰S CRITIQUES" >> ULTIMATE-REPORT.md
        grep -r "critical" nuclei-*.txt 2>/dev/null | head -20 >> ULTIMATE-REPORT.md || echo "Aucune vulnÃ©rabilitÃ© critique trouvÃ©e" >> ULTIMATE-REPORT.md
        
    - name: Upload ULTIMATE Results
      uses: actions/upload-artifact@v4
      with:
        name: nuclear-wp-recon-${{ github.run_id }}
        path: |
          ULTIMATE-REPORT.md
          *.txt
        retention-days: 7
        
    - name: Nuclear Alert
      if: always()
      run: |
        echo "ðŸš€ SCAN ULTIME TERMINÃ‰ !"
        echo "ðŸŽ¯ Cible: ${{ github.event.inputs.target_url }}"
        echo "ðŸ’¥ IntensitÃ©: ${{ github.event.inputs.intensity }}"
        echo "ðŸ”§ Type: ${{ github.event.inputs.scan_type }}"
