name: WordPress PRO Security Scan
on:
  workflow_dispatch:
    inputs:
      target_url:
        description: '🎯 URL du site WordPress à scanner'
        required: true
        type: string
        placeholder: 'https://example.com'
      scan_mode:
        description: '⚡ Mode de scan'
        required: true
        default: 'full'
        type: choice
        options:
        - quick
        - full
        - aggressive
  schedule:
    - cron: '0 2 * * *'  # Tous les jours à 2h

jobs:
  wordpress-pro-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate target URL
      run: |
        echo "🎯 Target URL: ${{ github.event.inputs.target_url }}"
        if [[ ! ${{ github.event.inputs.target_url }} =~ ^https?:// ]]; then
          echo "❌ ERROR: URL must start with http:// or https://"
          exit 1
        fi
        echo "✅ URL validation passed"
        
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y git python3 python3-pip golang-go ruby npm nmap nikto
        
    # === NUCLEI ===
    - name: Install Nuclei
      run: |
        go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
        export PATH=$PATH:$(go env GOPATH)/bin
        nuclei -update-templates
        
    # === WPSCAN ===  
    - name: Install WPScan
      run: |
        gem install wpscan --user-install
        export PATH="$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH"
        wpscan --update
        
    # === CMSMAP ===
    - name: Install CMSmap
      run: |
        git clone https://github.com/Dionach/CMSmap.git
        cd CMSmap && pip3 install . --user
        
    # === SUBDOMAIN TOOLS ===
    - name: Install subdomain tools
      run: |
        go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
        
    # === CONFIGURATION DU PATH ===
    - name: Setup environment paths
      run: |
        echo "PATH=$HOME/.local/bin:$(go env GOPATH)/bin:$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH" >> $GITHUB_ENV
        
    # === LANCEMENT DES SCANS ===
    
    - name: Run Nuclei WordPress Scan
      run: |
        echo "🔍 Starting Nuclei WordPress Scan..."
        nuclei -u "${{ github.event.inputs.target_url }}" \
        -t http/technologies/wordpress/ \
        -t http/vulnerabilities/wordpress/ \
        -t http/misconfiguration/wordpress/ \
        -t http/vulnerabilities/wordpress-plugins/ \
        -t http/vulnerabilities/wordpress-themes/ \
        -severity medium,high,critical \
        -rate-limit 100 \
        -silent \
        -o nuclei-results.txt
      continue-on-error: true
    
    - name: Run WPScan
      run: |
        echo "🛡️ Starting WPScan..."
        wpscan --url "${{ github.event.inputs.target_url }}" \
        --enumerate vp,vt,tt,u,m \
        --plugins-detection mixed \
        --max-threads 10 \
        -t 3 \
        --random-user-agent \
        --format cli-no-colour \
        --output wpscan-results.txt
      env:
        WPSCAN_API_TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}
      continue-on-error: true
    
    - name: Run CMSmap Scan
      run: |
        echo "🗺️ Starting CMSmap..."
        cd CMSmap && python3 cmsmap.py -t "${{ github.event.inputs.target_url }}" -f W --no-output --quiet
        cp output/*.txt ../cmsmap-results.txt 2>/dev/null || echo "No CMSmap output"
        
    - name: Run Subdomain Discovery
      run: |
        echo "🌐 Starting Subdomain Discovery..."
        domain=$(echo "${{ github.event.inputs.target_url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        
        subfinder -d $domain -silent > subdomains.txt
        if [ -s subdomains.txt ]; then
          httpx -l subdomains.txt -silent > live-subdomains.txt
        fi
        
    - name: Run Nikto Scan
      run: |
        echo "🚨 Starting Nikto..."
        domain=$(echo "${{ github.event.inputs.target_url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        nikto -h $domain -o nikto-results.txt || true
        
    - name: Run Nmap Scan
      run: |
        echo "📡 Starting Nmap..."
        domain=$(echo "${{ github.event.inputs.target_url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        nmap -p 80,443,8080 --script http-wordpress-enum,http-wordpress-users $domain > nmap-results.txt 2>&1 || true
        
    - name: Generate Security Report
      run: |
        echo "# 🔒 RAPPORT DE SÉCURITÉ WORDPRESS" > SECURITY-REPORT.md
        echo "## Scan réalisé le $(date)" >> SECURITY-REPORT.md
        echo "### Cible: ${{ github.event.inputs.target_url }}" >> SECURITY-REPORT.md
        echo "### Mode: ${{ github.event.inputs.scan_mode }}" >> SECURITY-REPORT.md
        echo "" >> SECURITY-REPORT.md
        
        echo "## 📊 RÉSULTATS" >> SECURITY-REPORT.md
        
        # Nuclei Results
        echo "### 🔍 NUCLEI" >> SECURITY-REPORT.md
        if [ -s nuclei-results.txt ]; then
          cat nuclei-results.txt >> SECURITY-REPORT.md
        else
          echo "Aucune vulnérabilité trouvée" >> SECURITY-REPORT.md
        fi
        echo "" >> SECURITY-REPORT.md
        
        # WPScan Results
        echo "### 🛡️ WPSCAN" >> SECURITY-REPORT.md
        if [ -s wpscan-results.txt ]; then
          grep -E "(vulnerability|Vulnerability|issue|Issue)" wpscan-results.txt >> SECURITY-REPORT.md || echo "Aucune vulnérabilité identifiée" >> SECURITY-REPORT.md
        else
          echo "Scan complété" >> SECURITY-REPORT.md
        fi
        echo "" >> SECURITY-REPORT.md
        
        # Sous-domaines
        echo "### 🌐 SOUS-DOMAINES" >> SECURITY-REPORT.md
        if [ -s live-subdomains.txt ]; then
          cat live-subdomains.txt >> SECURITY-REPORT.md
        else
          echo "Aucun sous-domaine trouvé" >> SECURITY-REPORT.md
        fi
        
    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: wp-scan-results-${{ github.run_id }}
        path: |
          SECURITY-REPORT.md
          *.txt
        retention-days: 7
        
    - name: Scan Complete
      if: always()
      run: |
        echo "✅ SCAN TERMINÉ !"
        echo "🎯 Cible: ${{ github.event.inputs.target_url }}"
        echo "📊 Rapport généré dans les artifacts"
